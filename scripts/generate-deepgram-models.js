#!/usr/bin/env node
/**
 * Generate Deepgram model constants from their public API
 *
 * Fetches model information from https://api.deepgram.com/v1/models
 * which returns all available STT and TTS models.
 *
 * Run: node scripts/generate-deepgram-models.js
 */

const fs = require("fs")
const path = require("path")

const API_URL = "https://api.deepgram.com/v1/models"
const OUTPUT_PATH = path.join(__dirname, "../src/generated/deepgram/models.ts")

async function main() {
  console.log("üì¶ Generating Deepgram model constants from API...")
  console.log(`   Fetching: ${API_URL}`)

  try {
    const response = await fetch(API_URL)
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }

    const data = await response.json()

    if (!data.stt || !Array.isArray(data.stt)) {
      throw new Error("Expected 'stt' array in API response")
    }

    // Extract unique model names and architectures
    const modelSet = new Set()
    const architectureSet = new Set()
    const modelDetails = []

    for (const model of data.stt) {
      const name = model.canonical_name || model.name
      const arch = model.architecture

      if (name && !modelSet.has(name)) {
        modelSet.add(name)
        architectureSet.add(arch)
        modelDetails.push({
          name,
          architecture: arch,
          version: model.version || null,
          languages: model.languages?.length || 0
        })
      }

      // Also add architecture-only names (e.g., "nova-3", "nova-2")
      if (arch && !modelSet.has(arch)) {
        modelSet.add(arch)
      }
    }

    // Sort models for consistent output
    const models = Array.from(modelSet).sort((a, b) => a.localeCompare(b))
    const architectures = Array.from(architectureSet).sort((a, b) => a.localeCompare(b))

    console.log(`   Found ${models.length} unique model names`)
    console.log(`   Found ${architectures.length} architectures`)

    // Generate TypeScript file
    const output = `/**
 * Generated from Deepgram API - DO NOT EDIT MANUALLY
 *
 * This file is auto-generated by scripts/generate-deepgram-models.js
 * Run 'pnpm openapi:sync-deepgram-models' to regenerate.
 *
 * @see https://api.deepgram.com/v1/models
 * @see https://developers.deepgram.com/docs/models-languages-overview
 *
 * @generated
 */

/**
 * All Deepgram STT model codes
 */
export const DeepgramModelCodes = [
${models.map((m) => `  "${m}"`).join(",\n")}
] as const

/**
 * Type for Deepgram model codes
 */
export type DeepgramModelCode = (typeof DeepgramModelCodes)[number]

/**
 * Deepgram model constant object for autocomplete
 *
 * @example
 * \`\`\`typescript
 * import { DeepgramModel } from 'voice-router-dev/constants'
 *
 * { model: DeepgramModel["nova-3"] }
 * { model: DeepgramModel["nova-2-medical"] }
 * \`\`\`
 */
export const DeepgramModel = {
${models.map((m) => `  "${m}": "${m}"`).join(",\n")}
} as const satisfies Record<string, DeepgramModelCode>

/**
 * Model name to display label mapping
 */
export const DeepgramModelLabels: Record<DeepgramModelCode, string> = {
${modelDetails
  .sort((a, b) => a.name.localeCompare(b.name))
  .map((m) => {
    // Create human-readable label
    const label = m.name
      .split("-")
      .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
      .join(" ")
    return `  "${m.name}": "${label}"`
  })
  .join(",\n")},
${models
  .filter((m) => !modelDetails.find((d) => d.name === m))
  .map((m) => {
    const label = m
      .split("-")
      .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
      .join(" ")
    return `  "${m}": "${label}"`
  })
  .join(",\n")}
}
`

    // Ensure output directory exists
    const outputDir = path.dirname(OUTPUT_PATH)
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true })
    }

    fs.writeFileSync(OUTPUT_PATH, output, "utf-8")
    console.log(`‚úÖ Generated ${OUTPUT_PATH}`)
    console.log(`   - ${models.length} models`)
    console.log(`   - Exports: DeepgramModelCodes, DeepgramModelCode, DeepgramModel, DeepgramModelLabels`)
  } catch (error) {
    console.error(`‚ùå Failed to fetch Deepgram models: ${error.message}`)
    process.exit(1)
  }
}

main()
