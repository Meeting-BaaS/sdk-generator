#!/usr/bin/env node
/**
 * Generate Soniox model constants from OpenAPI spec
 *
 * This script extracts model IDs from the GetModelsResponse example
 * in the Soniox OpenAPI spec and generates TypeScript constants.
 *
 * Run: node scripts/generate-soniox-models.js
 */

const fs = require("fs")
const path = require("path")

const SPEC_PATH = path.join(__dirname, "../specs/soniox-openapi.json")
const OUTPUT_PATH = path.join(__dirname, "../src/generated/soniox/models.ts")

function main() {
  console.log("ðŸ“¦ Generating Soniox model constants from OpenAPI spec...")

  // Read the OpenAPI spec
  if (!fs.existsSync(SPEC_PATH)) {
    console.error(`âŒ OpenAPI spec not found: ${SPEC_PATH}`)
    console.error("   Run 'pnpm openapi:sync:soniox' first to download the spec.")
    process.exit(1)
  }

  const spec = JSON.parse(fs.readFileSync(SPEC_PATH, "utf-8"))

  // Extract models from GetModelsResponse example
  const getModelsResponse = spec.components?.schemas?.GetModelsResponse
  if (!getModelsResponse?.example?.models) {
    console.error("âŒ Could not find GetModelsResponse.example.models in spec")
    process.exit(1)
  }

  const models = getModelsResponse.example.models
  console.log(`   Found ${models.length} models in spec`)

  // Separate real-time and async models
  const rtModels = models.filter((m) => m.transcription_mode === "real_time")
  const asyncModels = models.filter((m) => m.transcription_mode === "async")

  console.log(`   - ${rtModels.length} real-time models`)
  console.log(`   - ${asyncModels.length} async models`)

  // Helper to convert model ID to valid JS identifier
  // e.g., "stt-rt-v3" -> "stt_rt_v3"
  const toIdentifier = (id) => id.replace(/-/g, "_")

  // Generate TypeScript file
  const output = `/**
 * Generated from Soniox OpenAPI spec - DO NOT EDIT MANUALLY
 *
 * This file is auto-generated by scripts/generate-soniox-models.js
 * Run 'pnpm openapi:sync-soniox-models' to regenerate.
 *
 * @generated
 */

/**
 * Soniox model metadata
 * Derived from GetModelsResponse in OpenAPI spec
 */
export const SonioxModels = [
${models
  .map(
    (m) =>
      `  { id: "${m.id}", name: "${m.name}", mode: "${m.transcription_mode}"${m.aliased_model_id ? `, aliasOf: "${m.aliased_model_id}"` : ""} }`
  )
  .join(",\n")}
] as const

/**
 * Soniox model IDs
 */
export const SonioxModelCodes = [
${models.map((m) => `  "${m.id}"`).join(",\n")}
] as const

/**
 * Type for Soniox model codes
 */
export type SonioxModelCode = (typeof SonioxModelCodes)[number]

/**
 * Real-time streaming model IDs
 */
export const SonioxRealtimeModelCodes = [
${rtModels.map((m) => `  "${m.id}"`).join(",\n")}
] as const

/**
 * Type for Soniox real-time model codes
 */
export type SonioxRealtimeModelCode = (typeof SonioxRealtimeModelCodes)[number]

/**
 * Async/batch model IDs
 */
export const SonioxAsyncModelCodes = [
${asyncModels.map((m) => `  "${m.id}"`).join(",\n")}
] as const

/**
 * Type for Soniox async model codes
 */
export type SonioxAsyncModelCode = (typeof SonioxAsyncModelCodes)[number]

/**
 * Model ID to display name mapping
 */
export const SonioxModelLabels: Record<SonioxModelCode, string> = {
${models.map((m) => `  "${m.id}": "${m.name}"`).join(",\n")}
} as const

/**
 * Soniox model constant object for autocomplete
 *
 * @example
 * \`\`\`typescript
 * import { SonioxModel } from 'voice-router-dev/constants'
 *
 * // Real-time streaming
 * { model: SonioxModel.stt_rt_v3 }
 *
 * // Async/batch transcription
 * { model: SonioxModel.stt_async_v3 }
 * \`\`\`
 */
export const SonioxModel = {
${models.map((m) => `  ${toIdentifier(m.id)}: "${m.id}"`).join(",\n")}
} as const satisfies Record<string, SonioxModelCode>

/**
 * Real-time models only (for streaming)
 */
export const SonioxRealtimeModel = {
${rtModels.map((m) => `  ${toIdentifier(m.id)}: "${m.id}"`).join(",\n")}
} as const satisfies Record<string, SonioxRealtimeModelCode>

/**
 * Async models only (for batch transcription)
 */
export const SonioxAsyncModel = {
${asyncModels.map((m) => `  ${toIdentifier(m.id)}: "${m.id}"`).join(",\n")}
} as const satisfies Record<string, SonioxAsyncModelCode>
`

  // Ensure output directory exists
  const outputDir = path.dirname(OUTPUT_PATH)
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true })
  }

  fs.writeFileSync(OUTPUT_PATH, output, "utf-8")
  console.log(`âœ… Generated ${OUTPUT_PATH}`)
  console.log(`   - ${models.length} model codes`)
  console.log(`   - SonioxModels, SonioxModelCodes, SonioxModelCode, SonioxModelLabels, SonioxModel`)
  console.log(`   - SonioxRealtimeModel, SonioxAsyncModel (separated by mode)`)
}

main()
