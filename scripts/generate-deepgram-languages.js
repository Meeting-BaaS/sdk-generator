#!/usr/bin/env node
/**
 * Generate Deepgram language constants from their public API
 *
 * Fetches language codes from https://api.deepgram.com/v1/models
 * which returns all supported languages across all models.
 *
 * BCP-47 language tags as per RFC 5646:
 * @see https://www.iana.org/assignments/language-subtag-registry
 * @see https://www.rfc-editor.org/info/rfc5646
 *
 * Run: node scripts/generate-deepgram-languages.js
 */

const fs = require("fs")
const path = require("path")

const API_URL = "https://api.deepgram.com/v1/models"
const OUTPUT_PATH = path.join(__dirname, "../src/generated/deepgram/languages.ts")

async function main() {
  console.log("üì¶ Generating Deepgram language constants from API...")
  console.log(`   Fetching: ${API_URL}`)

  try {
    const response = await fetch(API_URL)
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }

    const data = await response.json()

    if (!data.stt || !Array.isArray(data.stt)) {
      throw new Error("Expected 'stt' array in API response")
    }

    // Extract all unique language codes from STT models
    const languageSet = new Set()
    for (const model of data.stt) {
      if (model.languages && Array.isArray(model.languages)) {
        for (const lang of model.languages) {
          languageSet.add(lang)
        }
      }
    }

    // Sort alphabetically
    const languages = Array.from(languageSet).sort((a, b) => a.localeCompare(b))
    console.log(`   Found ${languages.length} unique language codes`)

    // Separate primary codes from regional variants
    const primaryCodes = languages.filter((l) => !l.includes("-"))
    const regionalVariants = languages.filter((l) => l.includes("-"))

    // Generate TypeScript file
    const output = `/**
 * Generated from Deepgram API - DO NOT EDIT MANUALLY
 *
 * This file is auto-generated by scripts/generate-deepgram-languages.js
 * Run 'pnpm openapi:sync-deepgram-languages' to regenerate.
 *
 * BCP-47 language tags as per RFC 5646:
 * @see https://api.deepgram.com/v1/models
 * @see https://www.iana.org/assignments/language-subtag-registry
 * @see https://www.rfc-editor.org/info/rfc5646
 *
 * @generated
 */

/**
 * All Deepgram supported language codes (BCP-47)
 *
 * Includes both primary codes (e.g., 'en', 'es') and regional variants (e.g., 'en-US', 'pt-BR')
 */
export const DeepgramLanguageCodes = [
${languages.map((l) => `  "${l}"`).join(",\n")}
] as const

/**
 * Type for Deepgram language codes
 */
export type DeepgramLanguageCode = (typeof DeepgramLanguageCodes)[number]

/**
 * Deepgram language constant object for autocomplete
 *
 * @example
 * \`\`\`typescript
 * import { DeepgramLanguage } from 'voice-router-dev/constants'
 *
 * { language: DeepgramLanguage.en }
 * { language: DeepgramLanguage["en-US"] }
 * { language: DeepgramLanguage["pt-BR"] }
 * \`\`\`
 */
export const DeepgramLanguage = {
  // Primary language codes
${primaryCodes.map((l) => `  ${l}: "${l}"`).join(",\n")},

  // Regional variants
${regionalVariants.map((l) => `  "${l}": "${l}"`).join(",\n")}
} as const satisfies Record<string, DeepgramLanguageCode>
`

    // Ensure output directory exists
    const outputDir = path.dirname(OUTPUT_PATH)
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true })
    }

    fs.writeFileSync(OUTPUT_PATH, output, "utf-8")
    console.log(`‚úÖ Generated ${OUTPUT_PATH}`)
    console.log(`   - ${primaryCodes.length} primary codes`)
    console.log(`   - ${regionalVariants.length} regional variants`)
    console.log(`   - DeepgramLanguageCodes, DeepgramLanguageCode, DeepgramLanguage`)
  } catch (error) {
    console.error(`‚ùå Failed to fetch Deepgram models: ${error.message}`)
    process.exit(1)
  }
}

main()
