#!/usr/bin/env node
/**
 * Generate Speechmatics language constants from their Feature Discovery API
 *
 * Fetches language codes from https://eu1.asr.api.speechmatics.com/v1/discovery/features
 * which returns all supported languages and metadata.
 *
 * Run: node scripts/generate-speechmatics-languages.js
 */

const fs = require("fs")
const path = require("path")

const API_URL = "https://eu1.asr.api.speechmatics.com/v1/discovery/features"
const OUTPUT_PATH = path.join(__dirname, "../src/generated/speechmatics/languages.ts")

async function main() {
  console.log("üì¶ Generating Speechmatics language constants from Feature Discovery API...")
  console.log(`   Fetching: ${API_URL}`)

  try {
    const response = await fetch(API_URL)
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }

    const data = await response.json()

    if (!data.metadata?.language_pack_info) {
      throw new Error("Expected 'metadata.language_pack_info' in API response")
    }

    // Extract languages from metadata
    const languagePackInfo = data.metadata.language_pack_info
    const languages = Object.entries(languagePackInfo)
      .map(([code, info]) => ({
        code,
        name: info.language_description || code
      }))
      .sort((a, b) => a.code.localeCompare(b.code))

    // Add 'auto' for automatic language detection
    languages.unshift({ code: "auto", name: "Automatic Detection" })

    console.log(`   Found ${languages.length} language codes`)

    // Generate TypeScript file
    const output = `/**
 * Generated from Speechmatics Feature Discovery API - DO NOT EDIT MANUALLY
 *
 * This file is auto-generated by scripts/generate-speechmatics-languages.js
 * Run 'pnpm openapi:sync-speechmatics-languages' to regenerate.
 *
 * @see https://eu1.asr.api.speechmatics.com/v1/discovery/features
 * @see https://docs.speechmatics.com/speech-to-text/features/feature-discovery
 * @generated
 */

/**
 * Speechmatics supported language metadata
 * From Feature Discovery API
 */
export const SpeechmaticsLanguages = [
${languages.map((lang) => `  { code: "${lang.code}", name: "${lang.name}" }`).join(",\n")}
] as const

/**
 * Speechmatics supported language codes
 */
export const SpeechmaticsLanguageCodes = [
${languages.map((lang) => `  "${lang.code}"`).join(",\n")}
] as const

/**
 * Type for Speechmatics language codes
 */
export type SpeechmaticsLanguageCode = (typeof SpeechmaticsLanguageCodes)[number]

/**
 * Language code to name mapping
 */
export const SpeechmaticsLanguageLabels: Record<SpeechmaticsLanguageCode, string> = {
${languages.map((lang) => `  "${lang.code}": "${lang.name}"`).join(",\n")}
} as const

/**
 * Speechmatics language constant object for autocomplete
 *
 * Note: Includes special codes like 'auto' for automatic detection
 * and multilingual packs like 'cmn_en' for Mandarin+English.
 *
 * @example
 * \`\`\`typescript
 * import { SpeechmaticsLanguage } from 'voice-router-dev/constants'
 *
 * { language: SpeechmaticsLanguage.en }
 * { language: SpeechmaticsLanguage.auto }
 * { language: SpeechmaticsLanguage.cmn_en }
 * \`\`\`
 */
export const SpeechmaticsLanguage = {
${languages.map((lang) => `  "${lang.code}": "${lang.code}"`).join(",\n")}
} as const satisfies Record<string, SpeechmaticsLanguageCode>
`

    // Ensure output directory exists
    const outputDir = path.dirname(OUTPUT_PATH)
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true })
    }

    fs.writeFileSync(OUTPUT_PATH, output, "utf-8")
    console.log(`‚úÖ Generated ${OUTPUT_PATH}`)
    console.log(`   - ${languages.length} language codes`)
    console.log(
      `   - SpeechmaticsLanguages, SpeechmaticsLanguageCodes, SpeechmaticsLanguageCode, SpeechmaticsLanguageLabels, SpeechmaticsLanguage`
    )
  } catch (error) {
    console.error(`‚ùå Failed to fetch Speechmatics Feature Discovery: ${error.message}`)
    process.exit(1)
  }
}

main()
