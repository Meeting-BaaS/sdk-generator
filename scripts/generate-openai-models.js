#!/usr/bin/env node
/**
 * Generate OpenAI model constants from generated TypeScript types
 *
 * Extracts model values from orval-generated OpenAI types:
 * - CreateTranscriptionRequestModel (batch transcription)
 * - RealtimeSessionCreateRequestGAModel (realtime streaming)
 * - AudioTranscriptionModel (transcription)
 *
 * Run: node scripts/generate-openai-models.js
 */

const fs = require("fs")
const path = require("path")

const GENERATED_DIR = path.join(__dirname, "../src/generated/openai/schema")
const OUTPUT_PATH = path.join(__dirname, "../src/generated/openai/models.ts")

// Files to extract models from
const MODEL_SOURCES = [
  {
    file: "createTranscriptionRequestModel.ts",
    typeName: "CreateTranscriptionRequestModel",
    category: "transcription"
  },
  {
    file: "realtimeSessionCreateRequestGAModel.ts",
    typeName: "RealtimeSessionCreateRequestGAModel",
    category: "realtime"
  },
  {
    file: "audioTranscriptionModel.ts",
    typeName: "AudioTranscriptionModel",
    category: "transcription"
  }
]

/**
 * Extract string literal values from a TypeScript union type definition
 */
function extractModelsFromFile(filePath) {
  const content = fs.readFileSync(filePath, "utf-8")

  // Match quoted string literals in union types (e.g., | "whisper-1")
  const modelRegex = /\|\s*"([^"]+)"/g
  const models = []

  let match
  while ((match = modelRegex.exec(content)) !== null) {
    const model = match[1]
    // Skip generic "string" type
    if (model !== "string") {
      models.push(model)
    }
  }

  return models
}

async function main() {
  console.log("ðŸ“¦ Generating OpenAI model constants from generated types...")

  try {
    const allModels = new Set()
    const transcriptionModels = new Set()
    const realtimeModels = new Set()

    for (const source of MODEL_SOURCES) {
      const filePath = path.join(GENERATED_DIR, source.file)

      if (!fs.existsSync(filePath)) {
        console.log(`   âš ï¸  Skipping ${source.file} (not found)`)
        continue
      }

      const models = extractModelsFromFile(filePath)
      console.log(`   Found ${models.length} models in ${source.file}`)

      for (const model of models) {
        allModels.add(model)

        if (source.category === "realtime") {
          realtimeModels.add(model)
        } else {
          transcriptionModels.add(model)
        }
      }
    }

    const sortedAll = Array.from(allModels).sort()
    const sortedTranscription = Array.from(transcriptionModels).sort()
    const sortedRealtime = Array.from(realtimeModels).sort()

    console.log(`   Total: ${sortedAll.length} unique models`)
    console.log(`   - Transcription: ${sortedTranscription.length}`)
    console.log(`   - Realtime: ${sortedRealtime.length}`)

    // Generate TypeScript file
    const output = `/**
 * Generated from OpenAI TypeScript types - DO NOT EDIT MANUALLY
 *
 * This file is auto-generated by scripts/generate-openai-models.js
 * Run 'pnpm openapi:sync-openai-models' to regenerate.
 *
 * Source files:
 * - src/generated/openai/schema/createTranscriptionRequestModel.ts
 * - src/generated/openai/schema/realtimeSessionCreateRequestGAModel.ts
 * - src/generated/openai/schema/audioTranscriptionModel.ts
 *
 * @generated
 */

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// All OpenAI Models
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * All OpenAI audio model codes (transcription + realtime)
 */
export const OpenAIModelCodes = [
${sortedAll.map((m) => `  "${m}"`).join(",\n")}
] as const

/**
 * Type for all OpenAI model codes
 */
export type OpenAIModelCode = (typeof OpenAIModelCodes)[number]

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Transcription Models (Batch/Async)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * OpenAI transcription model codes (for batch transcription)
 */
export const OpenAITranscriptionModelCodes = [
${sortedTranscription.map((m) => `  "${m}"`).join(",\n")}
] as const

/**
 * Type for OpenAI transcription model codes
 */
export type OpenAITranscriptionModelCode = (typeof OpenAITranscriptionModelCodes)[number]

/**
 * OpenAI transcription model constant for autocomplete
 *
 * @example
 * \`\`\`typescript
 * import { OpenAITranscriptionModel } from 'voice-router-dev/constants'
 *
 * { model: OpenAITranscriptionModel["whisper-1"] }
 * { model: OpenAITranscriptionModel["gpt-4o-transcribe"] }
 * \`\`\`
 */
export const OpenAITranscriptionModel = {
${sortedTranscription.map((m) => `  "${m}": "${m}"`).join(",\n")}
} as const satisfies Record<string, OpenAITranscriptionModelCode>

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Realtime Models (Streaming)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * OpenAI realtime model codes (for streaming)
 */
export const OpenAIRealtimeModelCodes = [
${sortedRealtime.map((m) => `  "${m}"`).join(",\n")}
] as const

/**
 * Type for OpenAI realtime model codes
 */
export type OpenAIRealtimeModelCode = (typeof OpenAIRealtimeModelCodes)[number]

/**
 * OpenAI realtime model constant for autocomplete
 *
 * @example
 * \`\`\`typescript
 * import { OpenAIRealtimeModel } from 'voice-router-dev/constants'
 *
 * { model: OpenAIRealtimeModel["gpt-4o-realtime-preview"] }
 * \`\`\`
 */
export const OpenAIRealtimeModel = {
${sortedRealtime.map((m) => `  "${m}": "${m}"`).join(",\n")}
} as const satisfies Record<string, OpenAIRealtimeModelCode>

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Model Labels (for UI)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Model name to display label mapping
 */
export const OpenAIModelLabels: Record<OpenAIModelCode, string> = {
${sortedAll
  .map((m) => {
    // Create human-readable label
    const label = m
      .replace(/-/g, " ")
      .replace(/gpt 4o/g, "GPT-4o")
      .replace(/gpt realtime/g, "GPT Realtime")
      .replace(/whisper 1/g, "Whisper V2")
      .replace(/mini/g, "Mini")
      .replace(/preview/g, "Preview")
      .replace(/transcribe/g, "Transcribe")
      .replace(/diarize/g, "Diarize")
      .split(" ")
      .map((w) => (w.length <= 3 ? w : w.charAt(0).toUpperCase() + w.slice(1)))
      .join(" ")
    return `  "${m}": "${label}"`
  })
  .join(",\n")}
}
`

    // Ensure output directory exists
    const outputDir = path.dirname(OUTPUT_PATH)
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true })
    }

    fs.writeFileSync(OUTPUT_PATH, output, "utf-8")
    console.log(`âœ… Generated ${OUTPUT_PATH}`)
    console.log(`   - Exports: OpenAIModelCodes, OpenAIModelCode`)
    console.log(`   - Exports: OpenAITranscriptionModelCodes, OpenAITranscriptionModelCode, OpenAITranscriptionModel`)
    console.log(`   - Exports: OpenAIRealtimeModelCodes, OpenAIRealtimeModelCode, OpenAIRealtimeModel`)
    console.log(`   - Exports: OpenAIModelLabels`)
  } catch (error) {
    console.error(`âŒ Failed to generate OpenAI models: ${error.message}`)
    console.error(error.stack)
    process.exit(1)
  }
}

main()
