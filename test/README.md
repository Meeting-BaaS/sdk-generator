# Testing Guide for Meeting BaaS SDK

This directory contains comprehensive tests for the Meeting BaaS SDK, covering both unit tests and integration tests.

## Testing Stack

- **Vitest** - Fast, modern testing framework with native TypeScript support
- **MSW (Mock Service Worker)** - HTTP mocking for realistic API testing, with mocks generated by Orval
- **Coverage** - Built-in coverage reporting with `@vitest/coverage-v8`

## Test Structure

```
test/
├── setup.ts                 # Global test setup and MSW configuration
├── unit/                   # Unit tests for individual components
│   └── baas-client.test.ts # BaasClient class unit tests
├── integration/            # Integration tests for end-to-end workflows
│   ├── calendar-operations.test.ts
│   ├── bot-operations.test.ts
│   ├── utility-operations.test.ts
│   ├── webhook-operations.test.ts
│   └── example-usage.test.ts # Tests the example usage file
├── error-handling.test.ts  # Error scenario tests
└── README.md              # This file
```

## Running Tests

### Development

```bash
# Run unit test cases
pnpm test:unit

# Run integration test cases
pnpm test:integration

# Run error handling test cases
pnpm test:error-handling
```

### CI/CD

```bash
# Run tests with coverage
pnpm test:coverage

# Run all tests in CI mode
pnpm test
```

## Test Categories

### 1. Unit Tests (`test/unit/`)

- Test individual methods and functions in isolation
- Mock dependencies to focus on the unit under test
- Fast execution, high coverage

**Example:**

```typescript
describe('BaasClient', () => {
  it('should create a client with default configuration', () => {
    const client = createBaasClient({ api_key: 'test' })
    expect(client).toBeDefined()
  })
})
```

### 2. Integration Tests (`test/integration/`)

- Test complete workflows and API interactions
- Use Orval-generated MSW handlers to mock HTTP responses
- Test real data flow through the SDK

**Example:**

```typescript
describe('Calendar Operations Integration', () => {
  it('should create, list, get, update, and delete a calendar', async () => {
    // Test complete calendar lifecycle
    const createResult = await client.createCalendar({...})
    const listResult = await client.listCalendars()
    // ... more operations
  })
})
```

### 3. Error Handling Tests (`test/error-handling.test.ts`)

- Test various error scenarios (4xx, 5xx, network errors)
- Ensure proper error propagation
- Test edge cases and validation

### 4. Example Usage Test (`test/integration/example-usage.test.ts`)

- Runs all exported example functions from `examples/baas-client-usage.ts`
- Ensures documentation and usage examples always work with the current SDK
- Catches breaking changes in the public API and example code

## Mocking Strategy

### Orval-Generated MSW Handlers

- All MSW handlers are generated by Orval from the OpenAPI spec
- Handlers live in `src/generated/api/*/*.msw.ts`
- Realistic, type-safe mock data is generated for each endpoint
- No need to maintain custom handler files

### Dynamic Mocking

If you need to override a handler for a specific test, you can still use MSW's `server.use()` in your test setup:
```typescript
import { rest } from 'msw'
import { server } from '../setup'

server.use(
  rest.post('/bots/', (req, res, ctx) => {
    return res(ctx.status(400), ctx.json({ error: 'Bad Request' }))
  })
)
```

## Test Data Management

### Orval Mock Data

- Mock data is generated by Orval for each endpoint
- Ensures consistency and type safety across all tests
- No need for manual mock data factories

### Test Utilities (`test/setup.ts`)

- Common test utilities and helpers
- Global test configuration

## Best Practices

### 1. Test Organization

- Group related tests using `describe` blocks
- Use descriptive test names that explain the scenario
- Follow AAA pattern: Arrange, Act, Assert

### 2. Mocking

- Mock at the HTTP level using Orval-generated MSW handlers
- Use realistic mock data that matches your API schema
- Reset mocks between tests to avoid interference

### 3. Error Testing

- Test both happy path and error scenarios
- Verify error messages and status codes
- Test edge cases and boundary conditions

### 4. Async Testing

- Use `async/await` for asynchronous operations
- Test both resolved and rejected promises
- Use `expect().rejects.toThrow()` for error assertions

## Coverage Goals

- **Unit Tests**: 90%+ line coverage
- **Integration Tests**: 80%+ API endpoint coverage
- **Error Handling**: 100% error scenario coverage
- **Example Usage**: Example file is covered by integration tests

## Adding New Tests

### 1. For New API Endpoints

1. Ensure Orval generates the MSW handler for the new endpoint
2. Create unit test in `test/unit/`
3. Add integration test if needed in `test/integration/`
4. Add error handling tests

### 2. For New Features

1. Create unit tests for the feature
2. Add integration tests for workflows
3. Update Orval spec if needed
4. Add error scenarios

### 3. Test Template

```typescript
import { describe, it, expect, beforeEach } from 'vitest'
import { createBaasClient } from '../../src/baas/client'

describe('Feature Name', () => {
  let client: ReturnType<typeof createBaasClient>

  beforeEach(() => {
    client = createBaasClient({
      api_key: 'test-api-key'
    })
  })

  it('should perform expected behavior', async () => {
    // Arrange
    const input = { /* test data */ }
    
    // Act
    const result = await client.someMethod(input)
    
    // Assert
    expect(result).toHaveProperty('expectedField')
    expect(result.expectedField).toBe('expectedValue')
  })
})
```

## Debugging Tests

### 1. Using Vitest UI

```bash
pnpm test:ui
```
- Interactive test runner
- Real-time feedback
- Easy debugging

### 2. Debug Mode

```bash
# Run specific test file
pnpm test test/unit/baas-client.test.ts

# Run specific test
pnpm test -t "should join a meeting successfully"
```

### 3. MSW Debugging

- Check network tab in browser for MSW requests
- Use `server.listHandlers()` to see active handlers
- Add logging to handlers for debugging

## CI/CD Integration

### GitHub Actions Example

```yaml
- name: Run Tests
  run: pnpm test:coverage

- name: Upload Coverage
  uses: codecov/codecov-action@v3
  with:
    file: ./coverage/lcov.info
```

### Pre-commit Hooks

```json
{
  "husky": {
    "hooks": {
      "pre-commit": "pnpm test:run"
    }
  }
}
```

## Troubleshooting

### Common Issues

1. **MSW not intercepting requests**

   - Check that Orval-generated handlers are properly registered
   - Verify API base URL matches handler URL
   - Ensure server is started in test setup

2. **Type errors in tests**

   - Import types from generated files
   - Use proper type assertions
   - Check TypeScript configuration

3. **Async test failures**

   - Use proper async/await syntax
   - Check for unhandled promise rejections
   - Verify timeout settings

### Getting Help

- Check Vitest documentation: https://vitest.dev/
- MSW documentation: https://mswjs.io/
- Orval documentation: https://orval.dev/
- Review existing tests for patterns and examples